module.exports.On = function On(e,r){return(r,t,n)=>(r.hasOwnProperty("routes")||(r.routes=[]),r.routes.push({nameEvent:e,propertyKey:t}),n)}
module.exports.Prefix = function Prefix(n){return function(e){return class extends e{prefix=n}}}
module.exports.initSocketsServer = function initSocketsServer({http:e,mm:o,lm:t,distDir:n,gorilaSocketsConfig:s={},onError:r=console.error}){const c=require("path"),l=require("socket.io");let p=null,i=80;e?p=new l.Server(e,s):(s.port&&(i=s.port),process.env.PORT&&(i=parseInt(process.env.PORT)),p=l(i,s));const f=c.join(n,"socketsControllers"),v=require(f),d=[];for(const e in v){const t=v[e];if(t.prototype.routes){const e=t.prototype.routes;delete t.prototype.routes;let n=[];t.prototype.models&&(n=t.prototype.models.map((({propertyMod:e,model:t})=>({propertyMod:e,model:o.getModel(t)}))),delete t.prototype.models);const s=new t;s.io=p;for(const{propertyMod:e,model:o}of n)s[e]=o;let r="";s.prefix&&(r=`/${s.prefix}`,delete s.prefix);for(const{nameEvent:o,propertyKey:t}of e)d.push({nameEvent:o,callback:s[t].bind(s)})}}p.on("connect",(e=>{s.events&&s.events.onConnect&&s.events.onConnect(e);for(const{nameEvent:o,callback:n}of d)e.on(o,((...o)=>{const c=o.find((e=>"function"==typeof e));let l=o.filter((e=>"function"!=typeof e));const{getLibrary:i}=t;try{s.events&&s.events.onANewRequest&&(l=s.events.onANewRequest(l,e,i)),l.push(e,p);let o=n(...l);o instanceof Promise?o.then((o=>{s.events&&s.events.onBeforeToAnswer&&(o=socketsConfig.events.onBeforeToAnswer(o,e,i)),c&&c(o)})).catch((e=>{e={...e,error:!0,level:null!=e.code?1:0,code:null!=e.code?e.code:0,message:null!=e.message?e.message:e},c&&c(c),r(JSON.stringify(c))})):(s.events&&s.events.onBeforeToAnswer&&(o=socketsConfig.events.onBeforeToAnswer(o,e,i)),c&&c(o))}catch(o){o={...o,error:!0,level:0,code:void 0!==o.code?o.code:0,message:void 0!==o.message?o.message:o,stack:o.stack},r(JSON.stringify(c)),s.events&&s.events.onBeforeToAnswer&&(o=s.events.onBeforeToAnswer(o,e,i)),c&&c(contentReturn)}}))}))}